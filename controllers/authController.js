const User = require('../models/User');
const jwt = require('jsonwebtoken');
const { validationResult } = require('express-validator');
const { sendEmail } = require('../services/emailService');

// ======================
// ğŸ” Generate JWT
// ======================
const generateToken = (userId) => {
  return jwt.sign(
    { userId },
    process.env.JWT_SECRET || 'your-secret-key',
    { expiresIn: '7d' }
  );
};

// ======================
// ğŸ“ Register
// ======================
exports.register = async (req, res) => {
  try {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }

    const { name, email, password, company, phone, role } = req.body;

    const existingUser = await User.findOne({ email });
    if (existingUser) {
      return res.status(400).json({ error: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„' });
    }

    const user = new User({
      name,
      email,
      password,
      company,
      phone,
      role: role || 'employee',
    });

    await user.save();

    const token = generateToken(user._id);

    // ğŸ“§ Ø¥ÙŠÙ…ÙŠÙ„ ØªØ±Ø­ÙŠØ¨ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    try {
      await sendEmail({
        to: user.email,
        subject: 'ğŸ‰ Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¨Ø­ÙŠØ±Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
        html: `
          <div dir="rtl" style="font-family:Arial;padding:20px">
            <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ ${user.name} ğŸ‘‹</h2>
            <p>
              ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù†Ø¸Ø§Ù… <strong>Ø§Ù„Ø¨Ø­ÙŠØ±Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</strong>.
            </p>
            <p>
              ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¨Ø¯Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù….
            </p>
            <hr />
            <p style="color:#666;font-size:12px">
              Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
            </p>
          </div>
        `,
      });
    } catch (emailError) {
      console.error('âŒ Failed to send register email:', emailError.message);
    }

    return res.status(201).json({
      message: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­',
      user: {
        id: user._id,
        name: user.name,
        email: user.email,
        role: user.role,
        company: user.company,
        permissions: user.permissions || [],
      },
      token,
    });
  } catch (error) {
    console.error('âŒ Register error:', error);
    return res.status(500).json({ error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±' });
  }
};

// ======================
// ğŸ” Login + Welcome Email
// ======================
exports.login = async (req, res) => {
  try {
    const { email, password } = req.body;

    const user = await User.findOne({ email });
    if (!user) {
      return res.status(401).json({ error: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©' });
    }

    if (user.isBlocked) {
      return res.status(403).json({ error: 'User account is blocked' });
    }

    const isMatch = await user.comparePassword(password);
    if (!isMatch) {
      return res.status(401).json({ error: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©' });
    }

    const token = generateToken(user._id);

    // ======================
    // ğŸ“§ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    // ======================
    try {
      await sendEmail({
        to: user.email,
        subject: 'ğŸ‘‹ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­',
        html: `
          <div dir="rtl" style="font-family:Arial;padding:20px">
            <h2>Ø£Ù‡Ù„Ø§Ù‹ ${user.name} ğŸ‘‹</h2>
            <p>
              ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ù†Ø¸Ø§Ù… <strong>Ø§Ù„Ø¨Ø­ÙŠØ±Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</strong>.
            </p>
            <p>
              Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø£Ù†Øª Ù…Ù† Ù‚Ø§Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ ÙÙˆØ±Ù‹Ø§.
            </p>
            <hr />
            <p style="color:#666;font-size:12px">
              Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.
            </p>
          </div>
        `,
      });
    } catch (emailError) {
      console.error(
        'âŒ Failed to send login welcome email:',
        emailError.message
      );
    }

    return res.json({
      message: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­',
        user: {
          id: user._id,
          name: user.name,
          email: user.email,
          role: user.role,
          company: user.company,
          permissions: user.permissions || [],
        },
      token,
    });
  } catch (error) {
    console.error('âŒ Login error:', error);
    return res.status(500).json({ error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±' });
  }
};

// ======================
// ğŸ‘¤ Profile
// ======================
exports.getProfile = async (req, res) => {
  try {
    return res.json({
        user: {
          id: req.user._id,
          name: req.user.name,
          email: req.user.email,
          role: req.user.role,
          company: req.user.company,
          phone: req.user.phone,
          createdAt: req.user.createdAt,
          permissions: req.user.permissions || [],
        },
    });
  } catch (error) {
    console.error('âŒ Profile error:', error);
    return res.status(500).json({ error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±' });
  }
};
